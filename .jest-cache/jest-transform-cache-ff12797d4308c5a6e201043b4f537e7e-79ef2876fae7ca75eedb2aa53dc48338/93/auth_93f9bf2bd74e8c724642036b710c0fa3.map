{"version":3,"sources":["/Users/sachin/Documents/md-sports-/src/lib/auth.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\n// import jwt from 'jsonwebtoken'; replaced\nimport * as jose from 'jose';\nimport prisma from '@/lib/prisma';\nimport { hasPermission as checkPermission } from '@/lib/utils/permissions';\nimport CredentialsProvider from 'next-auth/providers/credentials';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'default-secret-key-for-development';\nconst NEXTAUTH_SECRET = process.env.NEXTAUTH_SECRET || process.env.JWT_SECRET || 'default-secret-key-for-development';\nconst secretKey = new TextEncoder().encode(JWT_SECRET);\n\n// Export authOptions for NextAuth\nexport const authOptions = {\n  secret: NEXTAUTH_SECRET,\n  providers: [\n    CredentialsProvider({\n      name: 'credentials',\n      credentials: {\n        email: { label: 'Email', type: 'email' },\n        password: { label: 'Password', type: 'password' }\n      },\n      async authorize(_credentials) {\n        // This is a placeholder - the actual authentication is handled by custom API routes\n        // NextAuth.js requires a provider to be configured even if we're using custom auth\n        return null;\n      }\n    })\n  ],\n  session: {\n    strategy: 'jwt' as const,\n    maxAge: 24 * 60 * 60, // 24 hours\n  },\n  callbacks: {\n    async jwt({ token, user }: { token: any; user?: any }) {\n      if (user) {\n        token.id = user.id;\n        token.permissions = user.permissions;\n      }\n      return token;\n    },\n    async session({ session, token }: { session: any; token: any }) {\n      if (token && session.user) {\n        session.user.id = token.id;\n        session.user.permissions = token.permissions;\n      }\n      return session;\n    }\n  }\n};\n\n/**\n * Verify a JWT token\n */\nexport const verifyToken = async (token: string): Promise<jose.JWTPayload | null> => {\n    try {\n        const { payload } = await jose.jwtVerify(token, secretKey, {\n            // Assuming HS256 algorithm, adjust if different\n            // algorithms: ['HS256'] \n        });\n        return payload;\n    } catch (error: any) {\n        if (error.code === 'ERR_JWT_EXPIRED') {\n            console.error('Token expired:', error.message);\n        } else if (error.code === 'ERR_JWS_INVALID' || error.code === 'ERR_JWS_SIGNATURE_VERIFICATION_FAILED' || error.code === 'ERR_JWT_CLAIM_VALIDATION_FAILED') {\n            console.error('Invalid token:', error.message);\n        } else {\n            console.error('Token verification error:', error.message);\n        }\n        return null;\n    }\n};\n\n/**\n * Extract token from authorization header\n */\nexport const extractToken = (req: NextRequest): string | null => {\n    const authHeader = req.headers.get('authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return null;\n    }\n    return authHeader.split(' ')[1];\n};\n\n/**\n * Validate if a user has a specific permission\n * @param req - Next.js request object\n * @param permission - Permission string to check\n * @returns Object with isValid flag and optional error message\n */\nexport const validateTokenPermission = async (req: NextRequest, permission: string): Promise<{ isValid: boolean; message?: string }> => {\n    try {\n        const token = extractToken(req);\n        console.log(`Checking permission \"${permission}\" with token: ${token ? `${token.substring(0, 10)}...` : 'none'}`);\n\n        if (!token) {\n            console.error('No token provided when checking permission:', permission);\n            return { isValid: false, message: 'Authentication required' };\n        }\n\n        // Special case for development token\n        if (token === 'dev-token') {\n            console.log(`Development mode: granting permission '${permission}'`);\n            return { isValid: true };\n        }\n\n        const payload = await verifyToken(token);\n        console.log('Token payload:', payload);\n\n        if (!payload || typeof payload !== 'object' || !('sub' in payload)) {\n            console.error('Invalid token payload when checking permission:', permission);\n            return { isValid: false, message: 'Invalid authentication token' };\n        }\n\n        const userId = payload.sub as string;\n\n        // Check if permission is in the token payload directly\n        if (payload.permissions && Array.isArray(payload.permissions)) {\n            const hasPermission = checkPermission(payload.permissions, permission);\n            console.log(`Permission check from token for \"${permission}\": ${hasPermission ? 'GRANTED' : 'DENIED'}`);\n            \n            if (hasPermission) {\n                return { isValid: true };\n            }\n        }\n\n        // If not in token or as fallback, get user with permissions from database\n        const user = await prisma.user.findUnique({\n            where: { id: userId }\n        });\n\n        if (!user) {\n            console.error(`User not found for ID: ${userId}`);\n            return { isValid: false, message: 'User not found' };\n        }\n\n        if (!user.permissions || !Array.isArray(user.permissions)) {\n            console.error(`User ${userId} has no permissions array`);\n            return { isValid: false, message: 'User has no permissions' };\n        }\n\n        // Check if user has the required permission\n        console.log(`User ${userId} permissions:`, user.permissions);\n        const hasPermission = checkPermission(user.permissions, permission);\n        console.log(`Permission check result for \"${permission}\": ${hasPermission ? 'GRANTED' : 'DENIED'}`);\n\n        return {\n            isValid: hasPermission,\n            message: hasPermission ? undefined : `Permission denied: '${permission}' is required`\n        };\n    } catch (error) {\n        console.error(`Error checking permission ${permission}:`, error);\n        return { isValid: false, message: `Error checking permission: ${error instanceof Error ? error.message : String(error)}` };\n    }\n};\n\n/**\n * Get user ID from token\n */\nexport const getUserIdFromToken = async (req: NextRequest): Promise<string | null> => {\n    const token = extractToken(req);\n\n    if (!token) {\n        return null;\n    }\n\n    // Special case for development token\n    if (token === 'dev-token') {\n        return '4447d3a9-595b-483e-b55a-38f0f6160121'; // Admin user ID for development\n    }\n\n    const payload = await verifyToken(token);\n\n    if (!payload || typeof payload !== 'object' || !('sub' in payload)) {\n        return null;\n    }\n\n    return payload.sub as string;\n};\n\n/**\n * Get shop ID from token\n */\nexport const getShopIdFromToken = async (req: NextRequest): Promise<string | null> => {\n    const token = extractToken(req);\n\n    if (!token) {\n        return null;\n    }\n\n    // Special case for development token - assign to first shop for testing shop staff behavior\n    if (token === 'dev-token') {\n        return 'cmbtr9q6l000061romoxi7uvf'; // Assign dev-token to first shop from database\n    }\n\n    const payload = await verifyToken(token);\n\n    if (!payload || typeof payload !== 'object' || !('shopId' in payload)) {\n        return null;\n    }\n\n    return payload.shopId as string;\n};"],"names":["authOptions","extractToken","getShopIdFromToken","getUserIdFromToken","validateTokenPermission","verifyToken","JWT_SECRET","process","env","NEXTAUTH_SECRET","secretKey","TextEncoder","encode","secret","providers","CredentialsProvider","name","credentials","email","label","type","password","authorize","_credentials","session","strategy","maxAge","callbacks","jwt","token","user","id","permissions","payload","jose","jwtVerify","error","code","console","message","req","authHeader","headers","get","startsWith","split","permission","log","substring","isValid","userId","sub","Array","isArray","hasPermission","checkPermission","prisma","findUnique","where","undefined","Error","String","shopId"],"mappings":";;;;;;;;;;;IAYaA,WAAW;eAAXA;;IA+DAC,YAAY;eAAZA;;IA2GAC,kBAAkB;eAAlBA;;IAxBAC,kBAAkB;eAAlBA;;IArEAC,uBAAuB;eAAvBA;;IApCAC,WAAW;eAAXA;;;8DAnDS;+DACH;6BAC8B;oEACjB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEhC,MAAMC,aAAaC,QAAQC,GAAG,CAACF,UAAU,IAAI;AAC7C,MAAMG,kBAAkBF,QAAQC,GAAG,CAACC,eAAe,IAAIF,QAAQC,GAAG,CAACF,UAAU,IAAI;AACjF,MAAMI,YAAY,IAAIC,cAAcC,MAAM,CAACN;AAGpC,MAAMN,cAAc;IACzBa,QAAQJ;IACRK,WAAW;QACTC,IAAAA,oBAAmB,EAAC;YAClBC,MAAM;YACNC,aAAa;gBACXC,OAAO;oBAAEC,OAAO;oBAASC,MAAM;gBAAQ;gBACvCC,UAAU;oBAAEF,OAAO;oBAAYC,MAAM;gBAAW;YAClD;YACA,MAAME,WAAUC,YAAY;gBAC1B,oFAAoF;gBACpF,mFAAmF;gBACnF,OAAO;YACT;QACF;KACD;IACDC,SAAS;QACPC,UAAU;QACVC,QAAQ,KAAK,KAAK;IACpB;IACAC,WAAW;QACT,MAAMC,KAAI,EAAEC,KAAK,EAAEC,IAAI,EAA8B;YACnD,IAAIA,MAAM;gBACRD,MAAME,EAAE,GAAGD,KAAKC,EAAE;gBAClBF,MAAMG,WAAW,GAAGF,KAAKE,WAAW;YACtC;YACA,OAAOH;QACT;QACA,MAAML,SAAQ,EAAEA,OAAO,EAAEK,KAAK,EAAgC;YAC5D,IAAIA,SAASL,QAAQM,IAAI,EAAE;gBACzBN,QAAQM,IAAI,CAACC,EAAE,GAAGF,MAAME,EAAE;gBAC1BP,QAAQM,IAAI,CAACE,WAAW,GAAGH,MAAMG,WAAW;YAC9C;YACA,OAAOR;QACT;IACF;AACF;AAKO,MAAMnB,cAAc,OAAOwB;IAC9B,IAAI;QACA,MAAM,EAAEI,OAAO,EAAE,GAAG,MAAMC,MAAKC,SAAS,CAACN,OAAOnB,WAAW;QAG3D;QACA,OAAOuB;IACX,EAAE,OAAOG,OAAY;QACjB,IAAIA,MAAMC,IAAI,KAAK,mBAAmB;YAClCC,QAAQF,KAAK,CAAC,kBAAkBA,MAAMG,OAAO;QACjD,OAAO,IAAIH,MAAMC,IAAI,KAAK,qBAAqBD,MAAMC,IAAI,KAAK,2CAA2CD,MAAMC,IAAI,KAAK,mCAAmC;YACvJC,QAAQF,KAAK,CAAC,kBAAkBA,MAAMG,OAAO;QACjD,OAAO;YACHD,QAAQF,KAAK,CAAC,6BAA6BA,MAAMG,OAAO;QAC5D;QACA,OAAO;IACX;AACJ;AAKO,MAAMtC,eAAe,CAACuC;IACzB,MAAMC,aAAaD,IAAIE,OAAO,CAACC,GAAG,CAAC;IACnC,IAAI,CAACF,cAAc,CAACA,WAAWG,UAAU,CAAC,YAAY;QAClD,OAAO;IACX;IACA,OAAOH,WAAWI,KAAK,CAAC,IAAI,CAAC,EAAE;AACnC;AAQO,MAAMzC,0BAA0B,OAAOoC,KAAkBM;IAC5D,IAAI;QACA,MAAMjB,QAAQ5B,aAAauC;QAC3BF,QAAQS,GAAG,CAAC,CAAC,qBAAqB,EAAED,WAAW,cAAc,EAAEjB,QAAQ,CAAC,EAAEA,MAAMmB,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC,GAAG,OAAO,CAAC;QAEhH,IAAI,CAACnB,OAAO;YACRS,QAAQF,KAAK,CAAC,+CAA+CU;YAC7D,OAAO;gBAAEG,SAAS;gBAAOV,SAAS;YAA0B;QAChE;QAEA,qCAAqC;QACrC,IAAIV,UAAU,aAAa;YACvBS,QAAQS,GAAG,CAAC,CAAC,uCAAuC,EAAED,WAAW,CAAC,CAAC;YACnE,OAAO;gBAAEG,SAAS;YAAK;QAC3B;QAEA,MAAMhB,UAAU,MAAM5B,YAAYwB;QAClCS,QAAQS,GAAG,CAAC,kBAAkBd;QAE9B,IAAI,CAACA,WAAW,OAAOA,YAAY,YAAY,CAAE,CAAA,SAASA,OAAM,GAAI;YAChEK,QAAQF,KAAK,CAAC,mDAAmDU;YACjE,OAAO;gBAAEG,SAAS;gBAAOV,SAAS;YAA+B;QACrE;QAEA,MAAMW,SAASjB,QAAQkB,GAAG;QAE1B,uDAAuD;QACvD,IAAIlB,QAAQD,WAAW,IAAIoB,MAAMC,OAAO,CAACpB,QAAQD,WAAW,GAAG;YAC3D,MAAMsB,gBAAgBC,IAAAA,0BAAe,EAACtB,QAAQD,WAAW,EAAEc;YAC3DR,QAAQS,GAAG,CAAC,CAAC,iCAAiC,EAAED,WAAW,GAAG,EAAEQ,gBAAgB,YAAY,SAAS,CAAC;YAEtG,IAAIA,eAAe;gBACf,OAAO;oBAAEL,SAAS;gBAAK;YAC3B;QACJ;QAEA,0EAA0E;QAC1E,MAAMnB,OAAO,MAAM0B,eAAM,CAAC1B,IAAI,CAAC2B,UAAU,CAAC;YACtCC,OAAO;gBAAE3B,IAAImB;YAAO;QACxB;QAEA,IAAI,CAACpB,MAAM;YACPQ,QAAQF,KAAK,CAAC,CAAC,uBAAuB,EAAEc,OAAO,CAAC;YAChD,OAAO;gBAAED,SAAS;gBAAOV,SAAS;YAAiB;QACvD;QAEA,IAAI,CAACT,KAAKE,WAAW,IAAI,CAACoB,MAAMC,OAAO,CAACvB,KAAKE,WAAW,GAAG;YACvDM,QAAQF,KAAK,CAAC,CAAC,KAAK,EAAEc,OAAO,yBAAyB,CAAC;YACvD,OAAO;gBAAED,SAAS;gBAAOV,SAAS;YAA0B;QAChE;QAEA,4CAA4C;QAC5CD,QAAQS,GAAG,CAAC,CAAC,KAAK,EAAEG,OAAO,aAAa,CAAC,EAAEpB,KAAKE,WAAW;QAC3D,MAAMsB,gBAAgBC,IAAAA,0BAAe,EAACzB,KAAKE,WAAW,EAAEc;QACxDR,QAAQS,GAAG,CAAC,CAAC,6BAA6B,EAAED,WAAW,GAAG,EAAEQ,gBAAgB,YAAY,SAAS,CAAC;QAElG,OAAO;YACHL,SAASK;YACTf,SAASe,gBAAgBK,YAAY,CAAC,oBAAoB,EAAEb,WAAW,aAAa,CAAC;QACzF;IACJ,EAAE,OAAOV,OAAO;QACZE,QAAQF,KAAK,CAAC,CAAC,0BAA0B,EAAEU,WAAW,CAAC,CAAC,EAAEV;QAC1D,OAAO;YAAEa,SAAS;YAAOV,SAAS,CAAC,2BAA2B,EAAEH,iBAAiBwB,QAAQxB,MAAMG,OAAO,GAAGsB,OAAOzB,OAAO,CAAC;QAAC;IAC7H;AACJ;AAKO,MAAMjC,qBAAqB,OAAOqC;IACrC,MAAMX,QAAQ5B,aAAauC;IAE3B,IAAI,CAACX,OAAO;QACR,OAAO;IACX;IAEA,qCAAqC;IACrC,IAAIA,UAAU,aAAa;QACvB,OAAO,wCAAwC,gCAAgC;IACnF;IAEA,MAAMI,UAAU,MAAM5B,YAAYwB;IAElC,IAAI,CAACI,WAAW,OAAOA,YAAY,YAAY,CAAE,CAAA,SAASA,OAAM,GAAI;QAChE,OAAO;IACX;IAEA,OAAOA,QAAQkB,GAAG;AACtB;AAKO,MAAMjD,qBAAqB,OAAOsC;IACrC,MAAMX,QAAQ5B,aAAauC;IAE3B,IAAI,CAACX,OAAO;QACR,OAAO;IACX;IAEA,4FAA4F;IAC5F,IAAIA,UAAU,aAAa;QACvB,OAAO,6BAA6B,+CAA+C;IACvF;IAEA,MAAMI,UAAU,MAAM5B,YAAYwB;IAElC,IAAI,CAACI,WAAW,OAAOA,YAAY,YAAY,CAAE,CAAA,YAAYA,OAAM,GAAI;QACnE,OAAO;IACX;IAEA,OAAOA,QAAQ6B,MAAM;AACzB"}