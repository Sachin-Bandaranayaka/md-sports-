{"version":3,"sources":["/Users/sachin/Documents/md-sports-/src/lib/auth.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\n// import jwt from 'jsonwebtoken'; replaced\nimport * as jose from 'jose';\nimport prisma from '@/lib/prisma';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'default-secret-key-for-development';\nconst secretKey = new TextEncoder().encode(JWT_SECRET);\n\n// Export authOptions for NextAuth\nexport const authOptions = {\n  secret: JWT_SECRET,\n  session: {\n    strategy: 'jwt' as const,\n    maxAge: 24 * 60 * 60, // 24 hours\n  },\n  callbacks: {\n    async jwt({ token, user }: { token: any; user?: any }) {\n      if (user) {\n        token.id = user.id;\n        token.permissions = user.permissions;\n      }\n      return token;\n    },\n    async session({ session, token }: { session: any; token: any }) {\n      if (token && session.user) {\n        session.user.id = token.id;\n        session.user.permissions = token.permissions;\n      }\n      return session;\n    }\n  }\n};\n\n/**\n * Verify a JWT token\n */\nexport const verifyToken = async (token: string): Promise<jose.JWTPayload | null> => {\n    try {\n        const { payload } = await jose.jwtVerify(token, secretKey, {\n            // Assuming HS256 algorithm, adjust if different\n            // algorithms: ['HS256'] \n        });\n        return payload;\n    } catch (error: any) {\n        if (error.code === 'ERR_JWT_EXPIRED') {\n            console.error('Token expired:', error.message);\n        } else if (error.code === 'ERR_JWS_INVALID' || error.code === 'ERR_JWS_SIGNATURE_VERIFICATION_FAILED' || error.code === 'ERR_JWT_CLAIM_VALIDATION_FAILED') {\n            console.error('Invalid token:', error.message);\n        } else {\n            console.error('Token verification error:', error.message);\n        }\n        return null;\n    }\n};\n\n/**\n * Extract token from authorization header\n */\nexport const extractToken = (req: NextRequest): string | null => {\n    const authHeader = req.headers.get('authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return null;\n    }\n    return authHeader.split(' ')[1];\n};\n\n/**\n * Validate if a user has a specific permission\n * @param req - Next.js request object\n * @param permission - Permission string to check\n * @returns Object with isValid flag and optional error message\n */\nexport const validateTokenPermission = async (req: NextRequest, permission: string): Promise<{ isValid: boolean; message?: string }> => {\n    try {\n        const token = extractToken(req);\n        console.log(`Checking permission \"${permission}\" with token: ${token ? `${token.substring(0, 10)}...` : 'none'}`);\n\n        if (!token) {\n            console.error('No token provided when checking permission:', permission);\n            return { isValid: false, message: 'Authentication required' };\n        }\n\n        // Special case for development token\n        if (token === 'dev-token') {\n            console.log(`Development mode: granting permission '${permission}'`);\n            return { isValid: true };\n        }\n\n        const payload = await verifyToken(token);\n        console.log('Token payload:', payload);\n\n        if (!payload || typeof payload !== 'object' || !('sub' in payload)) {\n            console.error('Invalid token payload when checking permission:', permission);\n            return { isValid: false, message: 'Invalid authentication token' };\n        }\n\n        const userId = Number(payload.sub);\n\n        // Check if permission is in the token payload directly\n        if (payload.permissions && Array.isArray(payload.permissions)) {\n            const hasPermission = payload.permissions.includes(permission);\n            console.log(`Permission check from token for \"${permission}\": ${hasPermission ? 'GRANTED' : 'DENIED'}`);\n            \n            if (hasPermission) {\n                return { isValid: true };\n            }\n        }\n\n        // If not in token or as fallback, get user with permissions from database\n        const user = await prisma.user.findUnique({\n            where: { id: userId }\n        });\n\n        if (!user) {\n            console.error(`User not found for ID: ${userId}`);\n            return { isValid: false, message: 'User not found' };\n        }\n\n        if (!user.permissions || !Array.isArray(user.permissions)) {\n            console.error(`User ${userId} has no permissions array`);\n            return { isValid: false, message: 'User has no permissions' };\n        }\n\n        // Check if user has the required permission\n        console.log(`User ${userId} permissions:`, user.permissions);\n        const hasPermission = user.permissions.includes(permission);\n        console.log(`Permission check result for \"${permission}\": ${hasPermission ? 'GRANTED' : 'DENIED'}`);\n\n        return {\n            isValid: hasPermission,\n            message: hasPermission ? undefined : `Permission denied: '${permission}' is required`\n        };\n    } catch (error) {\n        console.error(`Error checking permission ${permission}:`, error);\n        return { isValid: false, message: `Error checking permission: ${error instanceof Error ? error.message : String(error)}` };\n    }\n};\n\n/**\n * Get user ID from token\n */\nexport const getUserIdFromToken = async (req: NextRequest): Promise<number | null> => {\n    const token = extractToken(req);\n\n    if (!token) {\n        return null;\n    }\n\n    // Special case for development token\n    if (token === 'dev-token') {\n        return 1; // Development user ID\n    }\n\n    const payload = await verifyToken(token);\n\n    if (!payload || typeof payload !== 'object' || !('sub' in payload)) {\n        return null;\n    }\n\n    return Number(payload.sub);\n};\n\n/**\n * Get shop ID from token\n */\nexport const getShopIdFromToken = async (req: NextRequest): Promise<string | null> => {\n    const token = extractToken(req);\n\n    if (!token) {\n        return null;\n    }\n\n    // Special case for development token - assign to first shop for testing shop staff behavior\n    if (token === 'dev-token') {\n        return 'cmbtr9q6l000061romoxi7uvf'; // Assign dev-token to first shop from database\n    }\n\n    const payload = await verifyToken(token);\n\n    if (!payload || typeof payload !== 'object') {\n        return null;\n    }\n\n    // Extract shop ID from token as string to match database schema\n    return 'shopId' in payload ? String(payload.shopId) : null;\n};"],"names":["authOptions","extractToken","getShopIdFromToken","getUserIdFromToken","validateTokenPermission","verifyToken","JWT_SECRET","process","env","secretKey","TextEncoder","encode","secret","session","strategy","maxAge","callbacks","jwt","token","user","id","permissions","payload","jose","jwtVerify","error","code","console","message","req","authHeader","headers","get","startsWith","split","permission","log","substring","isValid","userId","Number","sub","Array","isArray","hasPermission","includes","prisma","findUnique","where","undefined","Error","String","shopId"],"mappings":"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"}