{"version":3,"sources":["/Users/sachin/Documents/md-sports-/tests/integration/inventoryTransfer.test.ts"],"sourcesContent":["import { describe, test, expect, beforeAll, afterAll } from '@jest/globals';\nimport { PrismaClient } from '@prisma/client';\n\n// Mock external dependencies BEFORE importing route handlers\n\n// 1. next/server (NextResponse)\n// Mock NextResponse (and any other exports we need) BEFORE importing route handlers\njest.mock('next/server', () => {\n  const mockNextResponse = {\n    json: (data: any, init?: { status?: number }) => ({\n      status: init?.status ?? 200,\n      json: async () => data,\n    }),\n  };\n  return {\n    NextResponse: mockNextResponse,\n  };\n});\n\n// 2. auth utilities – stub verifyToken to avoid ESM 'jose' parsing issues\njest.mock('@/lib/auth', () => {\n  return {\n    verifyToken: jest.fn(async (token: string) => {\n      if (token === 'dev-token') {\n        return {\n          sub: 'test-user',\n          shopId: 'shopA',\n          permissions: ['inventory:transfer', 'shop:manage'],\n        };\n      }\n      return null;\n    }),\n  };\n});\n\n// 3. Permission middleware – bypass actual permission checks\njest.mock('@/lib/utils/middleware', () => {\n  return {\n    requirePermission: (_permission: string) => {\n      return async () => null; // Always grant\n    },\n  };\n});\n\n// Polyfill minimal global Request/Headers so route modules that rely on them do not crash in Node\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nif (typeof global.Headers === 'undefined') {\n  // eslint-disable-next-line @typescript-eslint/no-var-requires\n  const { Headers, Request } = require('node-fetch');\n  // @ts-ignore\n  global.Headers = Headers;\n  // @ts-ignore\n  global.Request = Request;\n}\n\n// Import route handlers AFTER the mocks\nimport { POST as createTransferHandler } from '@/app/api/inventory/transfers/route';\nimport { DELETE as deleteTransferHandler } from '@/app/api/inventory/transfers/[id]/route';\nimport { POST as batchTransferHandler } from '@/app/api/inventory/transfers/batch/route';\n\n// Simple mock NextRequest / NextResponse similar to existing integration tests\ninterface MockRequest {\n  method: string;\n  url: string;\n  headers: Headers;\n  json(): Promise<any>;\n  text(): Promise<string>;\n}\n\nconst createMockRequest = (url: string, opts: { method?: string; body?: any; headers?: Record<string, string> } = {}): MockRequest => {\n  const { method = 'GET', body, headers = {} } = opts;\n  return {\n    method,\n    url,\n    headers: new Headers(headers),\n    json: async () => (typeof body === 'string' ? JSON.parse(body) : body),\n    text: async () => (typeof body === 'string' ? body : JSON.stringify(body)),\n  } as unknown as MockRequest;\n};\n\nconst prisma = new PrismaClient();\n\nconst DEV_HEADERS = {\n  authorization: 'Bearer dev-token',\n  'content-type': 'application/json',\n};\n\ndescribe('Inventory transfer reservation flow', () => {\n  let shopAId: string;\n  let shopBId: string;\n  let productId: number;\n\n  beforeAll(async () => {\n    // create two shops & product\n    // Provide explicit string IDs for shops to satisfy Prisma string primary key type\n    const shopA = await prisma.shop.create({ data: { id: 'shopA', name: 'Shop A', location: 'X' }, select: { id: true } });\n    const shopB = await prisma.shop.create({ data: { id: 'shopB', name: 'Shop B', location: 'Y' }, select: { id: true } });\n    shopAId = shopA.id;\n    shopBId = shopB.id;\n\n    const product = await prisma.product.create({\n      data: { name: 'Product A', price: 15, weightedAverageCost: 10.0 },\n      select: { id: true },\n    });\n    productId = product.id;\n\n    // add inventory 50 to shop A\n    await prisma.inventoryItem.create({ data: { productId, shopId: shopAId, quantity: 50, shopSpecificCost: 10 } });\n  });\n\n  afterAll(async () => {\n    await prisma.inventoryItem.deleteMany({});\n    await prisma.product.deleteMany({});\n    await prisma.shop.deleteMany({});\n    await prisma.$disconnect();\n  });\n\n  test('reservation, cancel, complete flow', async () => {\n    // 1. Create transfer 30 units pending\n    const createReq = createMockRequest('http://localhost/api/inventory/transfers', {\n      method: 'POST',\n      headers: DEV_HEADERS,\n      body: {\n        sourceShopId: shopAId,\n        destinationShopId: shopBId,\n        items: [{ productId, quantity: 30 }],\n      },\n    });\n\n    const createRes: any = await createTransferHandler(createReq as any);\n    expect(createRes.status).toBe(201);\n    const resBody = await createRes.json();\n    const transferId = resBody.data.id;\n\n    // verify source qty decreased to 20\n    const sourceInventoryAfter = await prisma.inventoryItem.findFirst({ where: { productId, shopId: shopAId } });\n    expect(sourceInventoryAfter?.quantity).toBe(20);\n\n    // 2. Cancel transfer -> qty back to 50\n    const deleteReq = createMockRequest(`http://localhost/api/inventory/transfers/${transferId}`, {\n      method: 'DELETE',\n      headers: DEV_HEADERS,\n    });\n    const deleteRes: any = await deleteTransferHandler(deleteReq as any, { params: Promise.resolve({ id: String(transferId) }) } as any);\n    expect(deleteRes.status).toBe(200);\n\n    const srcAfterCancel = await prisma.inventoryItem.findFirst({ where: { productId, shopId: shopAId } });\n    expect(srcAfterCancel?.quantity).toBe(50);\n\n    // 3. Re-create transfer and complete it\n    const createReq2 = createMockRequest('http://localhost/api/inventory/transfers', {\n      method: 'POST',\n      headers: DEV_HEADERS,\n      body: {\n        sourceShopId: shopAId,\n        destinationShopId: shopBId,\n        items: [{ productId, quantity: 30 }],\n      },\n    });\n    const createRes2: any = await createTransferHandler(createReq2 as any);\n    const newTransferId = (await createRes2.json()).data.id;\n\n    // batch complete\n    const batchReq = createMockRequest('http://localhost/api/inventory/transfers/batch', {\n      method: 'POST',\n      headers: DEV_HEADERS,\n      body: { transferIds: [newTransferId], action: 'complete' },\n    });\n    const batchRes: any = await batchTransferHandler(batchReq as any);\n    expect(batchRes.status).toBe(200);\n\n    // verify source qty remains 20, dest qty 30\n    const srcFinal = await prisma.inventoryItem.findFirst({ where: { productId, shopId: shopAId } });\n    expect(srcFinal?.quantity).toBe(20);\n\n    const destInv = await prisma.inventoryItem.findFirst({ where: { productId, shopId: shopBId } });\n    expect(destInv?.quantity).toBe(30);\n  });\n}); "],"names":["jest","mock","mockNextResponse","json","data","init","status","NextResponse","verifyToken","fn","token","sub","shopId","permissions","requirePermission","_permission","global","Headers","Request","require","createMockRequest","url","opts","method","body","headers","JSON","parse","text","stringify","prisma","PrismaClient","DEV_HEADERS","authorization","describe","shopAId","shopBId","productId","beforeAll","shopA","shop","create","id","name","location","select","shopB","product","price","weightedAverageCost","inventoryItem","quantity","shopSpecificCost","afterAll","deleteMany","$disconnect","test","createReq","sourceShopId","destinationShopId","items","createRes","createTransferHandler","expect","toBe","resBody","transferId","sourceInventoryAfter","findFirst","where","deleteReq","deleteRes","deleteTransferHandler","params","Promise","resolve","String","srcAfterCancel","createReq2","createRes2","newTransferId","batchReq","transferIds","action","batchRes","batchTransferHandler","srcFinal","destInv"],"mappings":"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"}