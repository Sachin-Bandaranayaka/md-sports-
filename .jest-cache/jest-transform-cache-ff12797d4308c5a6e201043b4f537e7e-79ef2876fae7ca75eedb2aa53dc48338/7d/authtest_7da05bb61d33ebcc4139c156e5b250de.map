{"version":3,"sources":["/Users/sachin/Documents/md-sports-/tests/unit/auth.test.ts"],"sourcesContent":["import { describe, it, expect, jest, beforeEach, afterEach } from '@jest/globals';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport { PrismaClient } from '@prisma/client';\n\n// Mock dependencies\njest.mock('bcryptjs');\njest.mock('jsonwebtoken', () => ({\n  sign: jest.fn(),\n  verify: jest.fn(),\n}));\njest.mock('@prisma/client');\n\nconst mockBcrypt = bcrypt as jest.Mocked<typeof bcrypt>;\nconst mockJwt = require('jsonwebtoken');\nconst mockPrisma = {\n  user: {\n    findUnique: jest.fn(),\n    create: jest.fn(),\n    update: jest.fn(),\n  },\n  refreshToken: {\n    create: jest.fn(),\n    findUnique: jest.fn(),\n    delete: jest.fn(),\n    deleteMany: jest.fn(),\n  },\n  $disconnect: jest.fn(),\n} as any;\n\n// Mock the auth service (we'll test the actual implementation)\nclass AuthService {\n  private prisma: PrismaClient;\n  \n  constructor() {\n    this.prisma = mockPrisma;\n  }\n\n  async login(email: string, password: string) {\n    // Find user by email\n    const user = await this.prisma.user.findUnique({\n      where: { email },\n      select: {\n        id: true,\n        email: true,\n        password: true,\n        name: true,\n        permissions: true,\n        isActive: true,\n        shopId: true,\n      },\n    });\n\n    if (!user) {\n      throw new Error('Invalid credentials');\n    }\n\n    if (!user.isActive) {\n      throw new Error('Account is deactivated');\n    }\n\n    // Verify password\n    const isValidPassword = await bcrypt.compare(password, user.password);\n    if (!isValidPassword) {\n      throw new Error('Invalid credentials');\n    }\n\n    // Generate tokens\n    const accessToken = this.generateAccessToken(user);\n    const refreshToken = await this.generateRefreshToken(user.id);\n\n    return {\n      user: {\n        id: user.id,\n        email: user.email,\n        name: user.name,\n        permissions: user.permissions,\n        shopId: user.shopId,\n      },\n      accessToken,\n      refreshToken,\n    };\n  }\n\n  private generateAccessToken(user: any) {\n    return jwt.sign(\n      {\n        userId: user.id,\n        email: user.email,\n        permissions: user.permissions,\n        shopId: user.shopId,\n      },\n      process.env.JWT_SECRET || 'test-secret',\n      { expiresIn: '15m' }\n    );\n  }\n\n  private async generateRefreshToken(userId: number) {\n    const token = jwt.sign(\n      { userId },\n      process.env.JWT_REFRESH_SECRET || 'test-refresh-secret',\n      { expiresIn: '7d' }\n    );\n\n    // Store refresh token in database\n    await this.prisma.refreshToken.create({\n      data: {\n        userId,\n        token,\n        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days\n      },\n    });\n\n    return token;\n  }\n\n  async verifyToken(token: string) {\n    try {\n      const decoded = jwt.verify(token, process.env.JWT_SECRET || 'test-secret');\n      return decoded;\n    } catch (error) {\n      throw new Error('Invalid token');\n    }\n  }\n\n  async refreshAccessToken(refreshToken: string) {\n    // Verify refresh token\n    const decoded = jwt.verify(\n      refreshToken,\n      process.env.JWT_REFRESH_SECRET || 'test-refresh-secret'\n    ) as any;\n\n    // Check if refresh token exists in database\n    const storedToken = await this.prisma.refreshToken.findUnique({\n      where: { token: refreshToken },\n      include: { user: true },\n    });\n\n    if (!storedToken || storedToken.isRevoked) {\n      throw new Error('Invalid refresh token');\n    }\n\n    if (new Date() > storedToken.expiresAt) {\n      throw new Error('Refresh token expired');\n    }\n\n    // Generate new access token\n    const newAccessToken = this.generateAccessToken(storedToken.user);\n\n    return {\n      accessToken: newAccessToken,\n      user: {\n        id: storedToken.user.id,\n        email: storedToken.user.email,\n        name: storedToken.user.name,\n        permissions: storedToken.user.permissions,\n        shopId: storedToken.user.shopId,\n      },\n    };\n  }\n\n  async logout(refreshToken: string) {\n    // Revoke refresh token\n    await this.prisma.refreshToken.deleteMany({\n      where: { token: refreshToken },\n    });\n  }\n\n  async logoutAllDevices(userId: number) {\n    // Revoke all refresh tokens for user\n    await this.prisma.refreshToken.deleteMany({\n      where: { userId },\n    });\n  }\n}\n\ndescribe('AuthService', () => {\n  let authService: AuthService;\n\n  beforeEach(() => {\n    authService = new AuthService();\n    jest.clearAllMocks();\n    \n    // Set up environment variables\n    process.env.JWT_SECRET = 'test-secret';\n    process.env.JWT_REFRESH_SECRET = 'test-refresh-secret';\n    \n    // Mock JWT methods\n    mockJwt.sign.mockReturnValue('mock-token');\n    mockJwt.verify.mockReturnValue({ userId: 1, email: 'test@example.com' });\n  });\n\n  afterEach(() => {\n    jest.resetAllMocks();\n  });\n\n  describe('login', () => {\n    const mockUser = {\n      id: 1,\n      email: 'test@example.com',\n      password: 'hashedPassword',\n      name: 'Test User',\n      permissions: ['inventory:read', 'sales:create'],\n      isActive: true,\n      shopId: 'shop-1',\n    };\n\n    it('should successfully login with valid credentials', async () => {\n      // Arrange\n      mockPrisma.user.findUnique.mockResolvedValue(mockUser);\n      mockBcrypt.compare.mockResolvedValue(true as never);\n      mockJwt.sign.mockReturnValue('mock-access-token' as never);\n      mockPrisma.refreshToken.create.mockResolvedValue({ token: 'mock-refresh-token' });\n\n      // Act\n      const result = await authService.login('test@example.com', 'password123');\n\n      // Assert\n      expect(mockPrisma.user.findUnique).toHaveBeenCalledWith({\n        where: { email: 'test@example.com' },\n        select: {\n          id: true,\n          email: true,\n          password: true,\n          name: true,\n          permissions: true,\n          isActive: true,\n          shopId: true,\n        },\n      });\n      expect(mockBcrypt.compare).toHaveBeenCalledWith('password123', 'hashedPassword');\n      expect(result).toEqual({\n        user: {\n          id: 1,\n          email: 'test@example.com',\n          name: 'Test User',\n          permissions: ['inventory:read', 'sales:create'],\n          shopId: 'shop-1',\n        },\n        accessToken: 'mock-access-token',\n        refreshToken: 'mock-access-token', // This would be the refresh token in real implementation\n      });\n    });\n\n    it('should throw error for non-existent user', async () => {\n      // Arrange\n      mockPrisma.user.findUnique.mockResolvedValue(null);\n\n      // Act & Assert\n      await expect(authService.login('nonexistent@example.com', 'password123'))\n        .rejects.toThrow('Invalid credentials');\n      \n      expect(mockBcrypt.compare).not.toHaveBeenCalled();\n    });\n\n    it('should throw error for inactive user', async () => {\n      // Arrange\n      const inactiveUser = { ...mockUser, isActive: false };\n      mockPrisma.user.findUnique.mockResolvedValue(inactiveUser);\n\n      // Act & Assert\n      await expect(authService.login('test@example.com', 'password123'))\n        .rejects.toThrow('Account is deactivated');\n      \n      expect(mockBcrypt.compare).not.toHaveBeenCalled();\n    });\n\n    it('should throw error for invalid password', async () => {\n      // Arrange\n      mockPrisma.user.findUnique.mockResolvedValue(mockUser);\n      mockBcrypt.compare.mockResolvedValue(false as never);\n\n      // Act & Assert\n      await expect(authService.login('test@example.com', 'wrongpassword'))\n        .rejects.toThrow('Invalid credentials');\n      \n      expect(mockBcrypt.compare).toHaveBeenCalledWith('wrongpassword', 'hashedPassword');\n    });\n\n    it('should handle database errors gracefully', async () => {\n      // Arrange\n      mockPrisma.user.findUnique.mockRejectedValue(new Error('Database connection failed'));\n\n      // Act & Assert\n      await expect(authService.login('test@example.com', 'password123'))\n        .rejects.toThrow('Database connection failed');\n    });\n  });\n\n  describe('verifyToken', () => {\n    it('should successfully verify valid token', async () => {\n      // Arrange\n      const mockDecoded = { userId: 1, email: 'test@example.com' };\n      const jwtVerifySpy = jest.spyOn(jwt, 'verify');\n      jwtVerifySpy.mockReturnValue(mockDecoded as never);\n\n      // Act\n      const result = await authService.verifyToken('valid-token');\n\n      // Assert\n      expect(jwtVerifySpy).toHaveBeenCalledWith('valid-token', 'test-secret');\n      expect(result).toEqual(mockDecoded);\n      \n      jwtVerifySpy.mockRestore();\n    });\n\n    it('should throw error for invalid token', async () => {\n      // Arrange\n      const jwtVerifySpy = jest.spyOn(jwt, 'verify');\n      jwtVerifySpy.mockImplementation(() => {\n        throw new Error('jwt malformed');\n      });\n\n      // Act & Assert\n      await expect(authService.verifyToken('invalid-token'))\n        .rejects.toThrow('Invalid token');\n        \n      jwtVerifySpy.mockRestore();\n    });\n\n    it('should throw error for expired token', async () => {\n      // Arrange\n      const jwtVerifySpy = jest.spyOn(jwt, 'verify');\n      jwtVerifySpy.mockImplementation(() => {\n        throw new Error('jwt expired');\n      });\n\n      // Act & Assert\n      await expect(authService.verifyToken('expired-token'))\n        .rejects.toThrow('Invalid token');\n        \n      jwtVerifySpy.mockRestore();\n    });\n  });\n\n  describe('refreshAccessToken', () => {\n    const mockRefreshToken = {\n      token: 'valid-refresh-token',\n      userId: 1,\n      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 1 day from now\n      isRevoked: false,\n      user: {\n        id: 1,\n        email: 'test@example.com',\n        name: 'Test User',\n        permissions: ['inventory:read'],\n        shopId: 'shop-1',\n      },\n    };\n\n    it('should successfully refresh access token', async () => {\n      // Arrange\n      const jwtVerifySpy = jest.spyOn(jwt, 'verify');\n      const jwtSignSpy = jest.spyOn(jwt, 'sign');\n      jwtVerifySpy.mockReturnValue({ userId: 1 } as never);\n      mockPrisma.refreshToken.findUnique.mockResolvedValue(mockRefreshToken);\n      jwtSignSpy.mockReturnValue('new-access-token' as never);\n\n      // Act\n      const result = await authService.refreshAccessToken('valid-refresh-token');\n\n      // Assert\n      expect(jwtVerifySpy).toHaveBeenCalledWith('valid-refresh-token', 'test-refresh-secret');\n      expect(mockPrisma.refreshToken.findUnique).toHaveBeenCalledWith({\n        where: { token: 'valid-refresh-token' },\n        include: { user: true },\n      });\n      expect(result).toEqual({\n        accessToken: 'new-access-token',\n        user: {\n          id: 1,\n          email: 'test@example.com',\n          name: 'Test User',\n          permissions: ['inventory:read'],\n          shopId: 'shop-1',\n        },\n      });\n      \n      jwtVerifySpy.mockRestore();\n      jwtSignSpy.mockRestore();\n    });\n\n    it('should throw error for revoked refresh token', async () => {\n      // Arrange\n      const revokedToken = { ...mockRefreshToken, isRevoked: true };\n      const jwtVerifySpy = jest.spyOn(jwt, 'verify');\n      jwtVerifySpy.mockReturnValue({ userId: 1 } as never);\n      mockPrisma.refreshToken.findUnique.mockResolvedValue(revokedToken);\n\n      // Act & Assert\n      await expect(authService.refreshAccessToken('revoked-token'))\n        .rejects.toThrow('Invalid refresh token');\n        \n      jwtVerifySpy.mockRestore();\n    });\n\n    it('should throw error for expired refresh token', async () => {\n      // Arrange\n      const expiredToken = {\n        ...mockRefreshToken,\n        expiresAt: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 day ago\n      };\n      const jwtVerifySpy = jest.spyOn(jwt, 'verify');\n      jwtVerifySpy.mockReturnValue({ userId: 1 } as never);\n      mockPrisma.refreshToken.findUnique.mockResolvedValue(expiredToken);\n\n      // Act & Assert\n      await expect(authService.refreshAccessToken('expired-token'))\n        .rejects.toThrow('Refresh token expired');\n        \n      jwtVerifySpy.mockRestore();\n    });\n\n    it('should throw error for non-existent refresh token', async () => {\n      // Arrange\n      const jwtVerifySpy = jest.spyOn(jwt, 'verify');\n      jwtVerifySpy.mockReturnValue({ userId: 1 } as never);\n      mockPrisma.refreshToken.findUnique.mockResolvedValue(null);\n\n      // Act & Assert\n      await expect(authService.refreshAccessToken('non-existent-token'))\n        .rejects.toThrow('Invalid refresh token');\n        \n      jwtVerifySpy.mockRestore();\n    });\n  });\n\n  describe('logout', () => {\n    it('should successfully logout user', async () => {\n      // Arrange\n      mockPrisma.refreshToken.deleteMany.mockResolvedValue({ count: 1 });\n\n      // Act\n      await authService.logout('refresh-token');\n\n      // Assert\n      expect(mockPrisma.refreshToken.deleteMany).toHaveBeenCalledWith({\n        where: { token: 'refresh-token' },\n      });\n    });\n\n    it('should handle logout even if token does not exist', async () => {\n      // Arrange\n      mockPrisma.refreshToken.deleteMany.mockResolvedValue({ count: 0 });\n\n      // Act & Assert\n      await expect(authService.logout('non-existent-token')).resolves.not.toThrow();\n    });\n  });\n\n  describe('logoutAllDevices', () => {\n    it('should successfully logout from all devices', async () => {\n      // Arrange\n      mockPrisma.refreshToken.deleteMany.mockResolvedValue({ count: 3 });\n\n      // Act\n      await authService.logoutAllDevices(1);\n\n      // Assert\n      expect(mockPrisma.refreshToken.deleteMany).toHaveBeenCalledWith({\n        where: { userId: 1 },\n      });\n    });\n\n    it('should handle logout all devices even if no tokens exist', async () => {\n      // Arrange\n      mockPrisma.refreshToken.deleteMany.mockResolvedValue({ count: 0 });\n\n      // Act & Assert\n      await expect(authService.logoutAllDevices(1)).resolves.not.toThrow();\n    });\n  });\n\n  describe('security considerations', () => {\n    it('should use secure JWT configuration', () => {\n      // Arrange\n      const mockUser = { id: 1, email: 'test@example.com', permissions: [], shopId: 'shop-1' };\n      \n      // Spy on jwt.sign to track calls\n      const jwtSignSpy = jest.spyOn(jwt, 'sign');\n      jwtSignSpy.mockReturnValue('mock-token' as any);\n      \n      // Act\n      authService['generateAccessToken'](mockUser);\n      \n      // Assert\n      expect(jwtSignSpy).toHaveBeenCalledWith(\n        expect.objectContaining({\n          userId: 1,\n          email: 'test@example.com',\n          permissions: [],\n          shopId: 'shop-1',\n        }),\n        'test-secret',\n        { expiresIn: '15m' }\n      );\n      \n      jwtSignSpy.mockRestore();\n    });\n\n    it('should not include password in token payload', () => {\n      const mockUser = {\n        id: 1,\n        email: 'test@example.com',\n        password: 'hashedPassword',\n        permissions: [],\n        shopId: 'shop-1',\n      };\n      \n      // Spy on jwt.sign to track calls\n      const jwtSignSpy = jest.spyOn(jwt, 'sign');\n      jwtSignSpy.mockReturnValue('mock-token' as any);\n      \n      // Act\n      authService['generateAccessToken'](mockUser);\n      \n      // Assert\n      const tokenPayload = jwtSignSpy.mock.calls[0][0];\n      expect(tokenPayload).not.toHaveProperty('password');\n      \n      jwtSignSpy.mockRestore();\n    });\n\n    it('should use different secrets for access and refresh tokens', async () => {\n      // This test ensures we're using different secrets for different token types\n      const mockUser = { id: 1, email: 'test@example.com', permissions: [], shopId: 'shop-1' };\n      \n      // Spy on jwt.sign to track calls\n      const jwtSignSpy = jest.spyOn(jwt, 'sign');\n      jwtSignSpy.mockReturnValue('mock-token' as any);\n      \n      // Mock the database call for refresh token creation\n      mockPrisma.refreshToken.create.mockResolvedValue({\n        id: 1,\n        userId: 1,\n        token: 'mock-refresh-token',\n        expiresAt: new Date(),\n        createdAt: new Date(),\n      });\n      \n      // Generate access token\n      authService['generateAccessToken'](mockUser);\n      \n      // Generate refresh token\n      await authService['generateRefreshToken'](1);\n      \n      // Assert different secrets are used\n      expect(jwtSignSpy).toHaveBeenCalledTimes(2);\n      \n      const calls = jwtSignSpy.mock.calls;\n      const accessTokenCall = calls[0];\n      const refreshTokenCall = calls[1];\n      \n      expect(accessTokenCall[1]).toBe('test-secret');\n      expect(refreshTokenCall[1]).toBe('test-refresh-secret');\n      expect(accessTokenCall[1]).not.toBe(refreshTokenCall[1]);\n      \n      jwtSignSpy.mockRestore();\n    });\n  });\n});"],"names":["jest","mock","sign","fn","verify","mockBcrypt","bcrypt","mockJwt","require","mockPrisma","user","findUnique","create","update","refreshToken","delete","deleteMany","$disconnect","AuthService","constructor","prisma","login","email","password","where","select","id","name","permissions","isActive","shopId","Error","isValidPassword","compare","accessToken","generateAccessToken","generateRefreshToken","jwt","userId","process","env","JWT_SECRET","expiresIn","token","JWT_REFRESH_SECRET","data","expiresAt","Date","now","verifyToken","decoded","error","refreshAccessToken","storedToken","include","isRevoked","newAccessToken","logout","logoutAllDevices","describe","authService","beforeEach","clearAllMocks","mockReturnValue","afterEach","resetAllMocks","mockUser","it","mockResolvedValue","result","expect","toHaveBeenCalledWith","toEqual","rejects","toThrow","not","toHaveBeenCalled","inactiveUser","mockRejectedValue","mockDecoded","jwtVerifySpy","spyOn","mockRestore","mockImplementation","mockRefreshToken","jwtSignSpy","revokedToken","expiredToken","count","resolves","objectContaining","tokenPayload","calls","toHaveProperty","createdAt","toHaveBeenCalledTimes","accessTokenCall","refreshTokenCall","toBe"],"mappings":"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"}