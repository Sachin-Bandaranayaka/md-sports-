{"version":3,"names":["GET","cov_24mgq6y4zr","f","s","fetchInventoryDistributionData","shopId","periodDays","startDate","endDate","categories","_prisma","safeQuery","prisma","category","findMany","inventoryItems","inventoryItem","where","b","include","product","categoryMap","Map","forEach","set","id","name","value","item","categoryId","categoryData","get","quantity","data","Array","from","values","filter","sort","a","success","_shopMiddleware","ShopAccessControl","withShopAccess","request","context","authResult","_auth","validateTokenPermission","isValid","_server","NextResponse","json","error","message","status","cacheKey","isFiltered","cachedData","_cache","cacheService","console","log","meta","shopFiltered","fromCache","inventoryResult","responseData","Error"],"sources":["/Users/sachin/Documents/md-sports-/src/app/api/dashboard/inventory/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { prisma, safeQuery } from '@/lib/prisma';\nimport { cacheService } from '@/lib/cache';\nimport { ShopAccessControl } from '@/lib/utils/shopMiddleware';\nimport { validateTokenPermission } from '@/lib/auth';\n\nexport async function fetchInventoryDistributionData(shopId?: string | null, periodDays?: number, startDate?: Date, endDate?: Date) {\n    // Get all categories\n    const categories = await safeQuery(\n        () => prisma.category.findMany(),\n        [], // Empty array fallback\n        'Failed to fetch categories'\n    );\n\n    // Get inventory items with their products and categories, with optional shop filtering\n    const inventoryItems = await safeQuery(\n        () => prisma.inventoryItem.findMany({\n            where: shopId ? { shopId } : {},\n            include: {\n                product: {\n                    include: {\n                        category: true\n                    }\n                }\n            }\n        }),\n        [], // Empty array fallback\n        'Failed to fetch inventory items'\n    );\n\n    // Create a map of category ID to aggregate data\n    const categoryMap = new Map();\n\n    // Initialize the map with all categories (including those with no inventory)\n    categories.forEach(category => {\n        categoryMap.set(category.id, {\n            name: category.name,\n            value: 0 // Start with zero\n        });\n    });\n\n    // Aggregate items by category\n    inventoryItems.forEach(item => {\n        if (item.product && item.product.category) {\n            const categoryId = item.product.categoryId;\n            const categoryData = categoryMap.get(categoryId) || {\n                name: item.product.category.name,\n                value: 0\n            };\n\n            // Increment the count for this category\n            categoryData.value += item.quantity;\n            categoryMap.set(categoryId, categoryData);\n        }\n    });\n\n    // Convert the map to an array\n    const data = Array.from(categoryMap.values())\n        // Filter out categories with no items\n        .filter(category => category.value > 0)\n        // Sort by count (highest first)\n        .sort((a, b) => b.value - a.value);\n\n    return {\n        success: true,\n        data\n    };\n}\n\n// GET: Fetch inventory distribution by category\nexport const GET = ShopAccessControl.withShopAccess(async (request: NextRequest, context) => {\n    try {\n        // Validate token and permissions\n        const authResult = await validateTokenPermission(request, 'view_dashboard');\n        if (!authResult.isValid) {\n            return NextResponse.json({ error: authResult.message }, { status: 401 });\n        }\n\n        // Check cache first with shop context\n        const cacheKey = `dashboard:inventory:${context.isFiltered ? context.shopId : 'all'}`;\n        const cachedData = await cacheService.get(cacheKey);\n\n        if (cachedData) {\n            console.log('âœ… Inventory data served from cache');\n            return NextResponse.json({\n                ...cachedData,\n                meta: {\n                    shopFiltered: context.isFiltered,\n                    shopId: context.shopId,\n                    fromCache: true\n                }\n            });\n        }\n\n        console.log('ðŸ”„ Fetching fresh inventory data with shop context:', {\n            shopId: context.shopId,\n            isFiltered: context.isFiltered\n        });\n        const inventoryResult = await fetchInventoryDistributionData(context.isFiltered ? context.shopId : null);\n\n        // Add metadata to response\n        const responseData = {\n            ...inventoryResult,\n            meta: {\n                shopFiltered: context.isFiltered,\n                shopId: context.shopId,\n                fromCache: false\n            }\n        };\n\n        // Cache for 3 minutes (inventory changes moderately)\n        await cacheService.set(cacheKey, responseData, 180);\n        console.log('ðŸ’¾ Inventory data cached for 3 minutes');\n\n        return NextResponse.json(responseData);\n    } catch (error) {\n        console.error('Error fetching inventory distribution:', error);\n        // Return empty array on error, consistent with original logic\n        return NextResponse.json({\n            success: true, // Or false, depending on desired error signaling\n            data: [],\n            message: error instanceof Error ? error.message : 'Unknown error',\n            meta: {\n                shopFiltered: context.isFiltered,\n                shopId: context.shopId\n            }\n        });\n    }\n});"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAsEaA,GAAG,WAAAA,CAAA;IAAA;IAAAC,cAAA,GAAAC,CA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","ignoreList":[]}