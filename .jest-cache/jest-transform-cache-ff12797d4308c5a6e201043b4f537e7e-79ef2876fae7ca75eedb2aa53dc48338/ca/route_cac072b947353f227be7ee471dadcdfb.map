{"version":3,"names":["GET","req","params","cov_h10jxyh9u","f","token","s","headers","get","replace","b","_server","NextResponse","json","success","message","status","user","_authService","getUserFromToken","isShopStaff","roleName","toLowerCase","hasAllPermissions","permissions","includes","hasBasicView","hasFullView","includeCosts","resolvedParams","id","shopId","costField","result","_db","default","query","data","rows","error","console","Error","String"],"sources":["/Users/sachin/Documents/md-sports-/src/app/api/inventory/shop/[id]/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { requirePermission } from '@/lib/utils/middleware';\nimport { getUserFromToken } from '@/services/authService';\nimport db from '@/utils/db';\n\nexport async function GET(\n    req: NextRequest,\n    { params }: { params: Promise<{ id: string }> }\n) {\n    // Check for inventory view permissions\n    const token = req.headers.get('authorization')?.replace('Bearer ', '');\n    \n    if (!token) {\n        return NextResponse.json({\n            success: false,\n            message: 'Authentication required'\n        }, { status: 401 });\n    }\n\n    // Get user to check specific permissions\n    const user = await getUserFromToken(token);\n    if (!user) {\n        return NextResponse.json({\n            success: false,\n            message: 'Invalid token'\n        }, { status: 401 });\n    }\n\n    // Allow Shop Staff to view any shop's inventory for transfers\n    const isShopStaff = user.roleName?.toLowerCase() === 'shop staff';\n\n    // Check if user has any inventory view permission\n    const hasAllPermissions = user.permissions?.includes('ALL');\n    const hasBasicView = user.permissions?.includes('inventory:view:basic');\n    const hasFullView = user.permissions?.includes('inventory:view');\n    \n    // Pass if user is shop staff, otherwise check permissions\n    if (!isShopStaff && !hasAllPermissions && !hasBasicView && !hasFullView) {\n        return NextResponse.json({\n            success: false,\n            message: 'Permission denied: inventory view access required'\n        }, { status: 403 });\n    }\n\n    // Determine if costs should be included (never for shop staff in this view)\n    const includeCosts = !isShopStaff && (hasAllPermissions || (hasFullView && !hasBasicView));\n\n    try {\n        // Await params before using its properties\n        const resolvedParams = await params;\n        \n        // Get the shop ID safely\n        if (!resolvedParams || !resolvedParams.id) {\n            return NextResponse.json({\n                success: false,\n                message: 'Shop ID is required',\n            }, { status: 400 });\n        }\n\n        const shopId = resolvedParams.id;\n\n        // Get inventory items for the shop with conditional cost inclusion\n        const costField = includeCosts ? 'i.shopspecificcost,' : '';\n        \n        const result = await db.query(\n            `SELECT \n                i.id,\n                i.\"productId\",\n                i.quantity,\n                p.id AS product_id,\n                p.name AS product_name,\n                p.description,\n                p.sku,\n                p.barcode,\n                p.price,\n                ${costField}\n                c.name AS category_name\n            FROM \n                \"InventoryItem\" i\n            JOIN \n                \"Product\" p ON i.\"productId\" = p.id\n            LEFT JOIN \n                \"Category\" c ON p.\"categoryId\" = c.id\n            WHERE \n                i.\"shopId\" = $1\n            ORDER BY\n                p.name`,\n            [shopId]\n        );\n\n        return NextResponse.json({\n            success: true,\n            data: result.rows\n        });\n    } catch (error) {\n        // Log the error\n        console.error(`Error fetching shop inventory:`, error);\n        return NextResponse.json({\n            success: false,\n            message: 'Failed to fetch shop inventory',\n            error: error instanceof Error ? error.message : String(error)\n        }, { status: 500 });\n    }\n}"],"mappings":"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","ignoreList":[]}