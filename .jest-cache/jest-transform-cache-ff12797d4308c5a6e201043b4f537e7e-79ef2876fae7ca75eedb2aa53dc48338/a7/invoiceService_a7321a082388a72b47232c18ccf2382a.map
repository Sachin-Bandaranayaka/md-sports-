{"version":3,"names":["deleteInvoice","invoiceId","userId","cov_29oeqobxpc","f","s","_prisma","default","$transaction","tx","auditService","_auditService","AuditService","getInstance","invoice","findUnique","where","id","include","items","customer","b","Error","softDelete","String","length","item","inventoryItem","updateMany","productId","shopId","data","quantity","increment","invoiceItem","deleteMany","delete","customerId","invoiceNumber"],"sources":["/Users/sachin/Documents/md-sports-/src/services/invoiceService.ts"],"sourcesContent":["import prisma from '@/lib/prisma';\nimport { AuditService } from './auditService';\n\nexport interface DeletedInvoiceResult {\n  id: number;\n  customerId?: number | null;\n  invoiceNumber?: string | null;\n  shopId?: string | null;\n}\n\n/**\n * Delete an invoice and related records inside a single transaction.\n * Returns a lightweight object with useful metadata for further follow-up\n * (cache invalidation, notifications, etc.).\n */\nexport async function deleteInvoice(invoiceId: number, userId: number): Promise<DeletedInvoiceResult> {\n  return await prisma.$transaction(async (tx) => {\n    const auditService = AuditService.getInstance();\n    const invoice = await tx.invoice.findUnique({\n      where: { id: invoiceId },\n      include: { items: true, customer: true }\n    });\n\n    if (!invoice) {\n      throw new Error('Invoice not found');\n    }\n\n    await auditService.softDelete('Invoice', invoiceId, invoice, String(userId), true);\n\n    // Adjust inventory\n    if (invoice.items.length > 0) {\n      for (const item of invoice.items) {\n        await tx.inventoryItem.updateMany({\n          where: { productId: item.productId, ...(invoice.shopId && { shopId: invoice.shopId }) },\n          data: { quantity: { increment: item.quantity } }\n        });\n      }\n    }\n\n    // After inventory adjustment\n    await tx.invoiceItem.deleteMany({ where: { invoiceId } });\n    await tx.invoice.delete({ where: { id: invoiceId } });\n\n    return {\n      id: invoiceId,\n      customerId: invoice.customerId,\n      invoiceNumber: invoice.invoiceNumber,\n      shopId: invoice.shopId\n    };\n  });\n} "],"mappings":"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","ignoreList":[]}