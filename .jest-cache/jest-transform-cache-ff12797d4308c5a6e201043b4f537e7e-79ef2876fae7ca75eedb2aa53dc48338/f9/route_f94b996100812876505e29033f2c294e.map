{"version":3,"names":["cov_2ibn0b0n4d","actualCoverage","s","GET","_shopMiddleware","ShopAccessControl","withShopAccess","request","context","f","authResult","_auth","validateTokenPermission","isValid","b","_server","NextResponse","json","error","message","status","cacheKey","isFiltered","shopId","cachedData","_cache","cacheService","get","console","log","meta","shopFiltered","fromCache","result","_prisma","prisma","$queryRaw","totalValue","total_value","formattedValue","Number","toFixed","replace","responseData","success","set","Error","String"],"sources":["/Users/sachin/Documents/md-sports-/src/app/api/dashboard/inventory-value/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\nimport { cacheService } from '@/lib/cache';\nimport { ShopAccessControl } from '@/lib/utils/shopMiddleware';\nimport { validateTokenPermission } from '@/lib/auth';\n\nexport const GET = ShopAccessControl.withShopAccess(async (request: NextRequest, context) => {\n    try {\n        // Validate token and permissions\n        const authResult = await validateTokenPermission(request, 'view_dashboard');\n        if (!authResult.isValid) {\n            return NextResponse.json({ error: authResult.message }, { status: 401 });\n        }\n\n        // Check cache first with shop context\n        const cacheKey = `dashboard:inventory-value:${context.isFiltered ? context.shopId : 'all'}`;\n        const cachedData = await cacheService.get(cacheKey);\n\n        if (cachedData) {\n            console.log('âœ… Inventory value served from cache');\n            return NextResponse.json({\n                ...cachedData,\n                meta: {\n                    shopFiltered: context.isFiltered,\n                    shopId: context.shopId,\n                    fromCache: true\n                }\n            });\n        }\n\n        console.log('ðŸ”„ Fetching fresh inventory value with shop context:', {\n            shopId: context.shopId,\n            isFiltered: context.isFiltered\n        });\n\n        // Direct SQL query to calculate inventory value with optional shop filtering using shop-specific cost\n        const result = context.isFiltered && context.shopId\n            ? await prisma.$queryRaw`\n                SELECT SUM(i.quantity * COALESCE(i.shopspecificcost, 0)) as total_value\n                FROM \"InventoryItem\" i\n                WHERE i.\"shopId\" = ${context.shopId}\n                AND i.quantity > 0\n                AND i.shopspecificcost IS NOT NULL\n                AND i.shopspecificcost > 0\n            `\n            : await prisma.$queryRaw`\n                SELECT SUM(i.quantity * COALESCE(i.shopspecificcost, 0)) as total_value\n                FROM \"InventoryItem\" i\n                WHERE i.quantity > 0\n                AND i.shopspecificcost IS NOT NULL\n                AND i.shopspecificcost > 0\n            `;\n\n        // Log the raw result\n        console.log('Raw inventory value result:', result);\n\n        // Extract the value from the result\n        const totalValue = result[0]?.total_value || 0;\n        console.log('Extracted total value:', totalValue);\n\n        // Format the value\n        const formattedValue = Number(totalValue).toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\");\n\n        const responseData = {\n            success: true,\n            totalValue,\n            formattedValue: `Rs. ${formattedValue}`,\n            meta: {\n                shopFiltered: context.isFiltered,\n                shopId: context.shopId,\n                fromCache: false\n            }\n        };\n\n        // Cache for 3 minutes (inventory value changes moderately)\n        await cacheService.set(cacheKey, responseData, 180);\n        console.log('ðŸ’¾ Inventory value cached for 3 minutes');\n\n        return NextResponse.json(responseData);\n    } catch (error) {\n        console.error('Error calculating inventory value:', error);\n        return NextResponse.json({\n            success: false,\n            message: 'Failed to calculate inventory value',\n            error: error instanceof Error ? error.message : String(error),\n            meta: {\n                shopFiltered: context.isFiltered,\n                shopId: context.shopId\n            }\n        }, { status: 500 });\n    }\n});"],"mappings":"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","ignoreList":[]}