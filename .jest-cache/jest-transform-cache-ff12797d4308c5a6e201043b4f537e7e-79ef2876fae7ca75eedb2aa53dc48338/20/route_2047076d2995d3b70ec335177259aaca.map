{"version":3,"names":["GET","cov_29cerbptvx","f","s","POST","req","url","URL","simple","searchParams","get","shopDistributionPermission","_auth","validateTokenPermission","shopManagePermission","b","isValid","_server","NextResponse","json","success","message","status","userShopId","getShopIdFromToken","adminAllPermission","userManagePermission","isAdmin","token","headers","split","isDevMode","console","log","whereClause","id","shops","_prisma","default","shop","findMany","where","select","name","orderBy","data","location","contact_person","phone","email","is_active","opening_time","closing_time","manager_id","opening_date","address_line1","address_line2","city","state","postal_code","country","latitude","longitude","tax_rate","createdAt","updatedAt","manager","_count","InventoryItem","shopsWithInventory","map","restOfShop","total_inventory","length","error","errorMessage","Error","request","body","newShop","create"],"sources":["/Users/sachin/Documents/md-sports-/src/app/api/shops/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport prisma from '@/lib/prisma';\nimport { validateTokenPermission, getShopIdFromToken } from '@/lib/auth';\nimport { ShopAccessControl } from '@/lib/utils/shopMiddleware';\n\nexport async function GET(req: NextRequest) {\n  try {\n    const url = new URL(req.url);\n    const simple = url.searchParams.get('simple') === 'true';\n\n    // Validate token and permissions - check for shop distribution view or shop manage\n    const shopDistributionPermission = await validateTokenPermission(req, 'shop:distribution:view');\n    const shopManagePermission = await validateTokenPermission(req, 'shop:manage');\n    \n    if (!shopDistributionPermission.isValid && !shopManagePermission.isValid) {\n      return NextResponse.json(\n        { success: false, message: 'Permission denied: shop:distribution:view or shop:manage required' },\n        { status: 401 }\n      );\n    }\n\n    // Get user's shop context for filtering\n    const userShopId = await getShopIdFromToken(req);\n    const adminAllPermission = await validateTokenPermission(req, 'admin:all');\n    const userManagePermission = await validateTokenPermission(req, 'user:manage');\n    \n    const isAdmin = shopManagePermission.isValid || adminAllPermission.isValid || userManagePermission.isValid;\n    \n    // Development mode - allow all access\n    const token = req.headers.get('authorization')?.split(' ')[1];\n    const isDevMode = token === 'dev-token';\n\n    // Debug logging\n    console.log('Shops API Debug:', {\n        isAdmin,\n        userShopId,\n        isDevMode,\n        shopManagePermission: shopManagePermission.isValid,\n        adminAllPermission: adminAllPermission.isValid,\n        userManagePermission: userManagePermission.isValid\n    });\n\n    if (simple) {\n      // Return simplified shop data for dropdowns\n      let whereClause = {};\n      \n      // If user is not admin, filter by their assigned shop\n       if (!isAdmin && userShopId) {\n         whereClause = {\n           id: userShopId\n         };\n         console.log('Applying shop filter:', whereClause);\n       } else {\n         console.log('No shop filter applied - isAdmin:', isAdmin, 'userShopId:', userShopId);\n       }\n      \n      const shops = await prisma.shop.findMany({\n        where: whereClause,\n        select: {\n          id: true,\n          name: true,\n        },\n        orderBy: {\n          name: 'asc',\n        },\n      });\n\n      return NextResponse.json({\n        success: true,\n        data: shops,\n      });\n    }\n\n        // Fetch shops from the database with proper numeric IDs\n        let whereClause = {};\n        \n        // If user is not admin, filter by their assigned shop\n         if (!isAdmin && userShopId) {\n             whereClause = {\n                 id: userShopId\n             };\n         }\n        \n        const shops = await prisma.shop.findMany({\n            where: whereClause,\n            orderBy: {\n                name: 'asc'\n            },\n            select: {\n                id: true,\n                name: true,\n                location: true,\n                contact_person: true,\n                phone: true,\n                email: true,\n                is_active: true,\n                opening_time: true,\n                closing_time: true,\n                manager_id: true,\n                opening_date: true,\n                status: true,\n                address_line1: true,\n                address_line2: true,\n                city: true,\n                state: true,\n                postal_code: true,\n                country: true,\n                latitude: true,\n                longitude: true,\n                tax_rate: true,\n                createdAt: true,\n                updatedAt: true,\n                manager: {\n                    select: {\n                        id: true,\n                        name: true,\n                        email: true,\n                        phone: true\n                    }\n                },\n                _count: {\n                    select: {\n                        InventoryItem: true\n                    }\n                }\n            }\n        });\n\n        // Transform the data to include total_inventory count\n        const shopsWithInventory = shops.map(shop => {\n            const { _count, ...restOfShop } = shop;\n            return {\n                ...restOfShop,\n                total_inventory: _count.InventoryItem\n            };\n        });\n\n        if (!shopsWithInventory || shopsWithInventory.length === 0) {\n            return NextResponse.json({ success: true, data: [] });\n        }\n\n        return NextResponse.json({ success: true, data: shopsWithInventory });\n\n    } catch (error) {\n        console.error('[API/SHOPS_GET] Error fetching shops:', error);\n        // It's good practice to avoid sending detailed internal error messages to the client.\n        let errorMessage = 'An unexpected error occurred while fetching shops.';\n        if (error instanceof Error) {\n            errorMessage = error.message;\n            // You could log error.message for server-side debugging\n        }\n        return NextResponse.json({ success: false, message: errorMessage }, { status: 500 });\n    }\n}\n\n// POST: Create a new shop\nexport async function POST(request: NextRequest) {\n    try {\n        const body = await request.json();\n\n        const newShop = await prisma.shop.create({\n            data: {\n                name: body.name,\n                location: body.location,\n                is_active: body.is_active,\n                status: body.status,\n            },\n        });\n\n        return NextResponse.json({\n            success: true,\n            data: newShop\n        }, { status: 201 });\n    } catch (error) {\n        console.error('Error creating shop:', error);\n        return NextResponse.json(\n            { success: false, message: 'Failed to create shop' },\n            { status: 500 }\n        );\n    }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}