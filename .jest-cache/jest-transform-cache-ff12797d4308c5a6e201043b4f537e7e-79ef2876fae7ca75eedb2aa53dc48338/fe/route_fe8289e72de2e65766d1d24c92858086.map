{"version":3,"names":["GET","cov_224nkb6iqt","f","s","POST","auditService","_auditService","AuditService","deletedCustomerIds","getDeletedEntityIds","customers","_prisma","prisma","customer","findMany","where","id","notIn","orderBy","name","include","invoices","createdAt","take","select","enrichedCustomers","map","lastInvoice","lastPurchaseDate","b","undefined","_server","NextResponse","json","error","console","success","message","Error","String","status","request","permissionError","_middleware","requirePermission","customerData","type","customerType","creditLimit","creditPeriod","parseFloat","parseInt","phone","trim","existingCustomer","findFirst","create","data","email","address"],"sources":["/Users/sachin/Documents/md-sports-/src/app/api/customers/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { requirePermission } from '@/lib/utils/middleware';\nimport { prisma } from '@/lib/prisma';\nimport { AuditService } from '@/services/auditService';\n\nexport async function GET() {\n    try {\n        // Get IDs of soft-deleted customers\n        const auditService = new AuditService();\n        const deletedCustomerIds = await auditService.getDeletedEntityIds('Customer');\n\n        // Fetch customers from database using Prisma\n        const customers = await prisma.customer.findMany({\n            where: {\n                id: {\n                    notIn: deletedCustomerIds\n                }\n            },\n            orderBy: {\n                name: 'asc'\n            },\n            include: {\n                invoices: {\n                    orderBy: {\n                        createdAt: 'desc'\n                    },\n                    take: 1,\n                    select: {\n                        createdAt: true\n                    }\n                }\n            }\n        });\n\n        // Add lastPurchaseDate field to each customer\n        const enrichedCustomers = customers.map(customer => {\n            const lastInvoice = customer.invoices?.[0];\n            return {\n                ...customer,\n                lastPurchaseDate: lastInvoice ? lastInvoice.createdAt : null,\n                // Remove the invoices array from the response to keep it clean\n                invoices: undefined\n            };\n        });\n\n        return NextResponse.json(enrichedCustomers);\n    } catch (error) {\n        console.error('Error fetching customers:', error);\n        return NextResponse.json(\n            {\n                success: false,\n                message: 'Error fetching customers',\n                error: error instanceof Error ? error.message : String(error)\n            },\n            { status: 500 }\n        );\n    }\n}\n\nexport async function POST(request: NextRequest) {\n    // Check for 'customer:create' permission\n    const permissionError = await requirePermission('customer:create')(request);\n    if (permissionError) {\n        return permissionError;\n    }\n\n    try {\n        const customerData = await request.json();\n\n        // Validate and transform incoming data\n        const type = customerData.customerType === 'Wholesale' ? 'wholesale' : 'retail';\n        let creditLimit = null;\n        let creditPeriod = null;\n\n        if (type === 'wholesale') {\n            creditLimit = parseFloat(customerData.creditLimit) || 0;\n            creditPeriod = parseInt(customerData.creditPeriod) || null;\n        }\n\n        // Check for duplicate mobile number if phone is provided\n        if (customerData.phone && customerData.phone.trim()) {\n            const existingCustomer = await prisma.customer.findFirst({\n                where: {\n                    phone: customerData.phone.trim()\n                }\n            });\n\n            if (existingCustomer) {\n                return NextResponse.json(\n                    {\n                        success: false,\n                        message: 'A customer with this mobile number already exists',\n                        error: 'Duplicate mobile number'\n                    },\n                    { status: 400 }\n                );\n            }\n        }\n\n        // Create new customer using Prisma\n        const customer = await prisma.customer.create({\n            data: {\n                name: customerData.name,\n                email: customerData.email || null,\n                phone: customerData.phone || null,\n                address: customerData.address || null, // Store address as a simple string\n                customerType: type, // Changed from type to customerType\n                creditLimit: creditLimit,\n                creditPeriod: creditPeriod,\n                // taxId and notes are removed as they are not in the Customer model\n                // The JSON blob for address is removed\n            }\n        });\n\n        return NextResponse.json(\n            {\n                success: true,\n                message: 'Customer created successfully',\n                data: customer\n            },\n            { status: 201 }\n        );\n    } catch (error) {\n        console.error('Error creating customer:', error);\n        return NextResponse.json(\n            {\n                success: false,\n                message: 'Error creating customer',\n                error: error instanceof Error ? error.message : String(error)\n            },\n            { status: 500 }\n        );\n    }\n}"],"mappings":"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","ignoreList":[]}