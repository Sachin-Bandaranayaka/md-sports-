{"version":3,"names":["cov_xqdg755ph","actualCoverage","s","GET","request","f","searchParams","URL","url","dateParam","get","targetDate","b","Date","startOfDay","setHours","endOfDay","shops","_prisma","prisma","shop","findMany","select","id","name","location","shopSalesData","Promise","all","map","salesAggregate","invoice","aggregate","_sum","total","_count","where","shopId","createdAt","gte","lte","paidAggregate","status","pendingAggregate","partialAggregate","invoices","include","customer","email","phone","items","product","sku","category","orderBy","totalQuantity","reduce","itemTotal","item","quantity","shopName","totalSales","numberOfInvoices","totalQuantitySold","averageTransactionValue","paidSales","paidInvoices","pendingSales","pendingInvoices","partialSales","partialInvoices","overallTotals","totals","totalInvoices","_server","NextResponse","json","success","reportDate","toISOString","split","summary","date","toLocaleDateString","weekday","year","month","day","numberOfShops","length","averagePerShop","shopData","generatedAt","error","console","message"],"sources":["/Users/sachin/Documents/md-sports-/src/app/api/reports/daily-sales/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\n\nexport async function GET(request: Request) {\n    try {\n        const { searchParams } = new URL(request.url);\n        const dateParam = searchParams.get('date');\n        \n        // Use provided date or default to today\n        const targetDate = dateParam ? new Date(dateParam) : new Date();\n        \n        // Set to start and end of the day\n        const startOfDay = new Date(targetDate);\n        startOfDay.setHours(0, 0, 0, 0);\n        \n        const endOfDay = new Date(targetDate);\n        endOfDay.setHours(23, 59, 59, 999);\n\n        // Get all shops\n        const shops = await prisma.shop.findMany({\n            select: {\n                id: true,\n                name: true,\n                location: true\n            }\n        });\n\n        // Get daily sales data for each shop\n        const shopSalesData = await Promise.all(\n            shops.map(async (shop) => {\n                // Get aggregated sales data for the shop (all invoices)\n                const salesAggregate = await prisma.invoice.aggregate({\n                    _sum: {\n                        total: true,\n                    },\n                    _count: {\n                        id: true,\n                    },\n                    where: {\n                        shopId: shop.id,\n                        createdAt: {\n                            gte: startOfDay,\n                            lte: endOfDay,\n                        },\n                        // Remove status filter to include all invoices\n                    },\n                });\n\n                // Get status-specific aggregates\n                const paidAggregate = await prisma.invoice.aggregate({\n                    _sum: { total: true },\n                    _count: { id: true },\n                    where: {\n                        shopId: shop.id,\n                        createdAt: { gte: startOfDay, lte: endOfDay },\n                        status: 'paid',\n                    },\n                });\n\n                const pendingAggregate = await prisma.invoice.aggregate({\n                    _sum: { total: true },\n                    _count: { id: true },\n                    where: {\n                        shopId: shop.id,\n                        createdAt: { gte: startOfDay, lte: endOfDay },\n                        status: 'pending',\n                    },\n                });\n\n                const partialAggregate = await prisma.invoice.aggregate({\n                    _sum: { total: true },\n                    _count: { id: true },\n                    where: {\n                        shopId: shop.id,\n                        createdAt: { gte: startOfDay, lte: endOfDay },\n                        status: 'partial',\n                    },\n                });\n\n                // Get detailed invoice data for the shop (all statuses)\n                const invoices = await prisma.invoice.findMany({\n                    where: {\n                        shopId: shop.id,\n                        createdAt: {\n                            gte: startOfDay,\n                            lte: endOfDay,\n                        },\n                        // Remove status filter to include all invoices\n                    },\n                    include: {\n                        customer: {\n                            select: {\n                                name: true,\n                                email: true,\n                                phone: true\n                            }\n                        },\n                        items: {\n                            include: {\n                                product: {\n                                    select: {\n                                        name: true,\n                                        sku: true,\n                                        category: true\n                                    }\n                                }\n                            }\n                        }\n                    },\n                    orderBy: {\n                        createdAt: 'desc',\n                    },\n                });\n\n                // Calculate total quantity sold\n                const totalQuantity = invoices.reduce((total, invoice) => {\n                    return total + invoice.items.reduce((itemTotal, item) => itemTotal + item.quantity, 0);\n                }, 0);\n\n                return {\n                    shopId: shop.id,\n                    shopName: shop.name,\n                    location: shop.location,\n                    totalSales: salesAggregate._sum.total || 0,\n                    numberOfInvoices: salesAggregate._count.id || 0,\n                    totalQuantitySold: totalQuantity,\n                    averageTransactionValue: salesAggregate._count.id > 0 \n                        ? (salesAggregate._sum.total || 0) / salesAggregate._count.id \n                        : 0,\n                    // Status breakdown\n                    paidSales: paidAggregate._sum.total || 0,\n                    paidInvoices: paidAggregate._count.id || 0,\n                    pendingSales: pendingAggregate._sum.total || 0,\n                    pendingInvoices: pendingAggregate._count.id || 0,\n                    partialSales: partialAggregate._sum.total || 0,\n                    partialInvoices: partialAggregate._count.id || 0,\n                    invoices: invoices\n                };\n            })\n        );\n\n        // Calculate overall totals\n        const overallTotals = shopSalesData.reduce(\n            (totals, shop) => ({\n                totalSales: totals.totalSales + shop.totalSales,\n                totalInvoices: totals.totalInvoices + shop.numberOfInvoices,\n                totalQuantity: totals.totalQuantity + shop.totalQuantitySold\n            }),\n            { totalSales: 0, totalInvoices: 0, totalQuantity: 0 }\n        );\n\n        return NextResponse.json({\n            success: true,\n            reportDate: targetDate.toISOString().split('T')[0],\n            summary: {\n                date: targetDate.toLocaleDateString('en-US', { \n                    weekday: 'long', \n                    year: 'numeric', \n                    month: 'long', \n                    day: 'numeric' \n                }),\n                totalSales: overallTotals.totalSales,\n                totalInvoices: overallTotals.totalInvoices,\n                totalQuantitySold: overallTotals.totalQuantity,\n                numberOfShops: shops.length,\n                averagePerShop: shops.length > 0 ? overallTotals.totalSales / shops.length : 0\n            },\n            shopData: shopSalesData,\n            generatedAt: new Date().toISOString()\n        });\n\n    } catch (error) {\n        console.error('Error fetching daily sales report:', error);\n        return NextResponse.json(\n            { success: false, message: 'Failed to fetch daily sales report' },\n            { status: 500 }\n        );\n    }\n}"],"mappings":"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","ignoreList":[]}