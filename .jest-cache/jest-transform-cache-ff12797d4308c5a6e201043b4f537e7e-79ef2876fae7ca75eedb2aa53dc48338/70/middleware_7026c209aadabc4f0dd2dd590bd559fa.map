{"version":3,"sources":["/Users/sachin/Documents/md-sports-/src/lib/utils/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { verifyToken, getUserFromToken, hasPermission } from '@/services/authService';\n\n/**\n * Middleware to require authentication\n */\nexport const requireAuth = () => {\n    return async (req: NextRequest) => {\n        try {\n            const token = req.headers.get('authorization')?.replace('Bearer ', '');\n\n            if (!token) {\n                return NextResponse.json(\n                    { success: false, message: 'Authentication required' },\n                    { status: 401 }\n                );\n            }\n\n            // Special case for development token\n            if (token === 'dev-token') {\n                console.log('Using development token - skipping verification');\n                return null;\n            }\n\n            // Use optimized cached authentication\n            const user = await getUserFromToken(token);\n\n            if (!user) {\n                return NextResponse.json(\n                    { success: false, message: 'Invalid token or user not found' },\n                    { status: 401 }\n                );\n            }\n\n            // User is authenticated\n            return null;\n        } catch (error) {\n            console.error('Auth error:', error);\n            return NextResponse.json(\n                { success: false, message: 'Authentication failed' },\n                { status: 401 }\n            );\n        }\n    };\n};\n\n/**\n * Middleware to require specific permission\n */\nexport const requirePermission = (permission: string) => {\n    return async (req: NextRequest) => {\n        try {\n            const token = req.headers.get('authorization')?.replace('Bearer ', '');\n            console.log(`Checking permission: ${permission} for token: ${token?.substring(0, 10)}...`);\n\n            if (!token) {\n                return NextResponse.json(\n                    { success: false, message: 'Authentication required' },\n                    { status: 401 }\n                );\n            }\n\n            // Special case for development token - only grant basic permissions, not admin\n            if (token === 'dev-token') {\n                const allowedDevPermissions = [\n                    'shop:distribution:view',\n                    'read:products',\n                    'write:products', \n                    'read:invoices',\n                    'write:invoices',\n                    'user:manage',\n                    'shop:manage',\n                    'inventory:manage',\n                    'settings:manage',\n                    'sales:manage',\n                    'sales:create:shop'\n                ];\n                \n                if (allowedDevPermissions.includes(permission)) {\n                    console.log(`Development mode: granting permission '${permission}'`);\n                    return null;\n                } else {\n                    console.log(`Development mode: denying admin permission '${permission}'`);\n                    return NextResponse.json(\n                        { success: false, message: `Permission denied: ${permission}` },\n                        { status: 403 }\n                    );\n                }\n            }\n\n            // Verify the token to get the payload first\n            const tokenPayload = await verifyToken(token);\n            if (!tokenPayload) {\n                console.error('Invalid token - payload could not be verified');\n                return NextResponse.json(\n                    { success: false, message: 'Invalid token' },\n                    { status: 401 }\n                );\n            }\n\n            // Now pass the TokenPayload object to hasPermission\n            const userHasPermission = await hasPermission(tokenPayload, permission);\n\n            if (!userHasPermission) {\n                console.error(`Permission denied: ${permission}`);\n                return NextResponse.json(\n                    { success: false, message: `Permission denied: ${permission}` },\n                    { status: 403 }\n                );\n            }\n\n            console.log(`Permission granted: ${permission}`);\n            return null;\n        } catch (error) {\n            console.error(`Permission check error for ${permission}:`, error);\n            return NextResponse.json(\n                { success: false, message: 'Permission check failed' },\n                { status: 500 }\n            );\n        }\n    };\n};\n\n/**\n * Get user ID from token\n */\nexport async function getUserId(req: NextRequest): Promise<string | null> {\n    const authHeader = req.headers.get('authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return null;\n    }\n\n    const token = authHeader.split(' ')[1];\n\n    // Special case for development token\n    if (token === 'dev-token') {\n        return '1'; // Development user ID\n    }\n\n    try {\n        // Use optimized cached user lookup\n        const user = await getUserFromToken(token);\n        return user ? user.id : null;\n    } catch (error) {\n        console.error('Token verification error:', error);\n        return null;\n    }\n}\n\n/**\n * Get user's shop ID from token\n * Used for shop-specific operations\n */\nexport async function getShopId(req: NextRequest): Promise<number | null> {\n    const authHeader = req.headers.get('authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return null;\n    }\n\n    const token = authHeader.split(' ')[1];\n\n    // Special case for development token\n    if (token === 'dev-token') {\n        return null; // Development user might not have a shop\n    }\n\n    try {\n        // Use optimized cached user lookup\n        const user = await getUserFromToken(token);\n        return user ? user.shopId : null;\n    } catch (error) {\n        console.error('Token verification error:', error);\n        return null;\n    }\n}"],"names":["getShopId","getUserId","requireAuth","requirePermission","req","token","headers","get","replace","NextResponse","json","success","message","status","console","log","user","getUserFromToken","error","permission","substring","allowedDevPermissions","includes","tokenPayload","verifyToken","userHasPermission","hasPermission","authHeader","startsWith","split","id","shopId"],"mappings":"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"}